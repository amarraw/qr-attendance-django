name: Django CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Run Django Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Create Superuser
        run: |
           echo "from django.contrib.autimport get_user_model; \
    User = get_user_model(); \
    User.objects.create_superuser('admin','admin@example.com','password')" \
    | python manage.py shell

      - name: Run tests
        id: run-tests
        run: |
          python manage.py test

  notify:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "CI Success ✅"
          to: alin.raw01@gmail.com
          body: "All tests passed! Ready to deploy."

      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "CI Failed ❌"
          to: alin.raw01@gmail.com
          body: "Tests failed! Check CI logs for details."

  deploy:
    needs: test
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
