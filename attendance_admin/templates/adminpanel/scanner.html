{% extends 'adminpanel/base.html' %}
{% load static %}
{% block title %}Scanner{% endblock %}
{% block extra_head %}
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="{% static 'adminpanel/icons/icon-192.png' %}">
{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card p-3">
      <div class="card-body text-center">
        <h4 class="mb-2">QR Scanner (PWA Ready)</h4>
        <p class="small text-muted">Allow camera access and point to a student's QR code. If camera fails, use the upload fallback below.</p>

        <div id="controls" class="mb-2 d-flex gap-2 justify-content-center flex-wrap">
          <select id="cameraSelect" class="form-select w-auto"></select>
          <button id="switchBtn" class="btn btn-outline-secondary">Switch</button>
          <div class="form-check form-check-inline align-self-center">
            <input class="form-check-input" type="checkbox" id="useLaptopToggle">
            <label class="form-check-label" for="useLaptopToggle">Use laptop / default camera</label>
          </div>
        </div>

        <video id="video" playsinline autoplay muted class="w-100" style="max-height:60vh; border-radius:8px; background:#000;"></video>

        <div id="result" class="mt-3"></div>

        <div class="mt-3">
          <button id="uploadBtn" class="btn btn-outline-primary" type="button">Upload QR image</button>
          <input id="uploadInput" type="file" accept="image/*" capture="environment" style="display:none;">
        </div>

        <!-- Help & ngrok QR helper -->
        <div id="pwaHelp" class="mt-3 text-start small">
          <div id="helpText" class="alert alert-light text-muted" role="alert">
            If camera is blocked on mobile: <ol>
              <li>Serve the site over HTTPS (use <strong>ngrok</strong> during testing).</li>
              <li>Open the HTTPS URL in your mobile browser (Safari/Chrome).</li>
              <li>If camera still fails, upload a QR image using the button above.</li>
            </ol>
          </div>

          <div class="mb-2">
            <label class="form-label">Quick open on device (paste ngrok HTTPS URL):</label>
            <div class="d-flex gap-2">
              <input id="ngrokUrl" class="form-control form-control-sm" placeholder="https://abcd-12-34-56.ngrok.io">
              <button id="renderQrBtn" class="btn btn-sm btn-secondary">Generate QR</button>
              <button id="copyBtn" class="btn btn-sm btn-outline-secondary">Copy</button>
            </div>
          </div>
          <div id="qrCanvas" style="max-width:180px;"></div>
        </div>

        <div id="diagnostic" class="mt-3 text-start small text-muted"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
<!-- Optional: QR generator library for nicer QR rendering (fallback uses Google Charts API) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
<script src="{% static 'adminpanel/scanner.js' %}"></script>
<script>
// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register("{% static 'adminpanel/service-worker.js' %}")
    .then(() => console.log('SW registered'))
    .catch(err => console.log('SW reg failed', err));
}
</script>
{% endblock %}